<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PawHub - Shop</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="styles/stylenav.css">
    <link rel="stylesheet" href="styles/styleshop.css">
</head>

<body>
    <div id="app">
        <!-- Vue will render the Navbar component here -->
        <Navbar></Navbar>
    </div>
    <div class="shop-header">
        <h1>Shop</h1>
    </div>
    <div class="shop-container">

        <div class="filter-search">
            <button class="filter-btn" id="filterBtn"><i class="fas fa-filter"></i> Filter</button>
            <input type="text" placeholder="Search..." id="searchInput">
            <a class='newListing' href="new-listing.html">
                <button class="add-btn"><i class="fas fa-plus"></i></button>
            </a>            
        </div>

        <h3>Top Items</h3>
        <div class="row" id="productContainer"></div>
        <button class="show-more" id="showMoreBtn">Show More</button>
        <button class="show-less" id="showLessBtn" style="display: none;">Show Less</button> <!-- Hidden by default -->

    </div>
    <div class="filter-sidebar" id="filterSidebar">
        <div class="filter-close" id="filterClose">&times;</div>
        <div class="filter-section">
            <h4>Items</h4>
            <label><input type="checkbox" id="dogFoodFilter"> Dog Food</label><br>
            <label><input type="checkbox" id="dogAccessoriesFilter"> Dog Accessories</label><br>
            <label><input type="checkbox" id="dogToysFilter"> Dog Toys</label>
        </div>
        <div class="filter-section">
            <h4>Location</h4>
            <label><input type="checkbox" id="locationCentral"> Central</label><br>
            <label><input type="checkbox" id="locationNorth"> North</label><br>
            <label><input type="checkbox" id="locationSouth"> South</label><br>
            <label><input type="checkbox" id="locationEast"> East</label><br>
            <label><input type="checkbox" id="locationWest"> West</label>
        </div>
        <div class="filter-section">
            <h4>Prices</h4>
            <div class="range-slider-container">
                <input type="range" class="range-slider" id="priceMin" min="0" max="100" value="0">
                <input type="range" class="range-slider" id="priceMax" min="0" max="100" value="100">
            </div>
            <p>Price range: $<span id="minPriceValue">0</span> - $<span id="maxPriceValue">100</span></p>
        </div>
        <button class="apply-filter-btn" id="applyFilterBtn">Apply Filter</button>
    </div>
    <script type="module">
        import Navbar from './Navbar.js';

        // Create and mount the Vue app after the DOM is ready
        const app = Vue.createApp({
            components: {
                Navbar
            }
        });

        app.mount('#app'); // Mount the app to the #app element
    </script>
    
    <script type="module">
        import { app } from "../firebase.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, limit, startAfter, getDocs } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        import { getStorage } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";

        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        let allProducts = [];  // Global array to store all fetched products
        const showMoreBtn = document.getElementById('showMoreBtn');
        const productContainer = document.getElementById('productContainer');
        const searchInput = document.getElementById('searchInput');
        
        const minPriceValue = document.getElementById('minPriceValue');
        const maxPriceValue = document.getElementById('maxPriceValue');
        const sliderTrack = document.getElementById('sliderTrack');

                let lastVisible = null;
        let productsToShow = 4;

        filterBtn.addEventListener('click', () => {
            filterSidebar.classList.add('active');
        });

        filterClose.addEventListener('click', () => {
            filterSidebar.classList.remove('active');
        });

        // Event listener for the "Apply Filter" button
        let allProducts = [];  // Store all products fetched from Firestore

// Fetch all products from Firestore
async function fetchAllProducts() {
    // resetProductContainer();


    const listingsQuery = query(
        collection(db, "marketplace"),
        orderBy("title"),  // Adjust this as needed for your sorting logic
        limit(productsToShow)  // Show only the first batch of products
    );
    const querySnapshot = await getDocs(collection(db, "marketplace"));
    allProducts = [];
    querySnapshot.forEach((doc) => {
        allProducts.push(doc.data());
    });
    lastVisible = querySnapshot.docs[querySnapshot.docs.length - 1];
    displayProducts(allProducts);  // Display all products initially
}

// Display products
function displayProducts(products) {
    productContainer.innerHTML = '';  // Clear the container
    products.forEach((product) => {
        const productCard = document.createElement('div');
        productCard.className = 'col-lg-3 col-md-4 col-sm-6';
        const imageURL = (product.imageURLs && product.imageURLs.length > 0) ? product.imageURLs[0] : 'https://via.placeholder.com/180';
        productCard.innerHTML = `
            <div class="product-card">
                <div class="user-info">
                    <img src="https://via.placeholder.com/40" alt="user profile">
                    <div class="user-details">
                        <p><strong>User</strong></p> <!-- Placeholder for user name -->
                    </div>
                </div>
                <img src="${imageURL}" alt="${product.title}">
                <div class="card-body">
                    <h5>${product.title}</h5>
                    <p class="price">S$${product.price}</p>
                    <p class="description">${product.description || "No description provided"}</p>
                </div>
                <div class="location-info">
                    <i class="fas fa-map-marker-alt"></i>
                    <p>${product.location}</p> <!-- Placeholder for location -->
                </div>
            </div>`;
        productContainer.appendChild(productCard);
    });
}

// Filter products based on selected filters
function filterProducts() {
    // resetProductContainer();
    const dogFoodFilter = document.getElementById('dogFoodFilter').checked;
    const dogAccessoriesFilter = document.getElementById('dogAccessoriesFilter').checked;
    const dogToysFilter = document.getElementById('dogToysFilter').checked;

    const locationCentral = document.getElementById('locationCentral').checked;
    const locationNorth = document.getElementById('locationNorth').checked;
    const locationSouth = document.getElementById('locationSouth').checked;
    const locationEast = document.getElementById('locationEast').checked;
    const locationWest = document.getElementById('locationWest').checked;

    const minPrice = parseFloat(document.getElementById('priceMin').value);
    const maxPrice = parseFloat(document.getElementById('priceMax').value);

    let filteredProducts = allProducts.filter(product => {
        const price = parseFloat(product.price);

        // Category filter
        const selectedCats = [];
    if (dogFoodFilter) selectedCats.push('dogFood');
    if (dogAccessoriesFilter) selectedCats.push('dogAccessories');
    if (dogToysFilter) selectedCats.push('dogToys');

        // Location filter
        const selectedLocations = [];
    if (locationCentral) selectedLocations.push('Central');
    if (locationNorth) selectedLocations.push('North');
    if (locationSouth) selectedLocations.push('South');
    if (locationEast) selectedLocations.push('East');
    if (locationWest) selectedLocations.push('West');
    let filteredProducts = allProducts.filter(product => {
        const price = parseFloat(product.price);

        // Category filter
        let categoryMatch = true;
        if (selectedCats.length > 0 && !selectedCats.includes(product.category)) {
            categoryMatch = false;
        }
        // Location filter
        let locationMatch = true;
        if (selectedLocations.length > 0) {
            if (Array.isArray(product.location)) {
                // Check if any of the product's locations match the selected locations
                locationMatch = product.location.some(loc => selectedLocations.includes(loc));
            } else {
                // For products with a single location (not an array)
                locationMatch = selectedLocations.includes(product.location);
            }
        }

        // Price filter
        let priceMatch = price >= minPrice && price <= maxPrice;

        return categoryMatch && locationMatch && priceMatch;
    });

    displayProducts(filteredProducts);  // Display filtered products

    if (filteredProducts.length <= productsToShow) {
        showMoreBtn.style.display = 'none';
    } else {
        showMoreBtn.style.display = 'block';
    }
});
}

// Event listener for the "Apply Filter" button
applyFilterBtn.addEventListener('click', () => {
    filterProducts();  // Filter and display the products
});

// Fetch and display all products when the page loads
fetchAllProducts();


        priceMin.addEventListener('input', updateSlider);
        priceMax.addEventListener('input', updateSlider);

        function updateSlider() {
            if (parseInt(priceMin.value) > parseInt(priceMax.value)) {
                priceMin.value = priceMax.value;
            }
            minPriceValue.textContent = priceMin.value;
            maxPriceValue.textContent = priceMax.value;

            const percentMin = (priceMin.value / priceMax.max) * 100;
            const percentMax = (priceMax.value / priceMax.max) * 100;
            sliderTrack.style.left = `${percentMin}%`;
            sliderTrack.style.width = `${percentMax - percentMin}%`;
        }

        updateSlider();

        // function resetProductContainer() {
        //     productContainer.innerHTML = '';  // Clear the container
        //     lastVisible = null;               // Reset pagination tracker
        // }
        
        // Fetch and display listings from Firestore
        async function loadListings(initialLoad = true) {
            // if (initialLoad) {
            //     resetProductContainer();  // Reset container for a fresh start
            // }
            const listingsQuery = query(
                collection(db, "marketplace"),
                orderBy("title"), // Ordering by title or any other field
                limit(productsToShow),
                startAfter(lastVisible || 0)
            );

            const querySnapshot = await getDocs(listingsQuery);
            if (!querySnapshot.empty) {
                lastVisible = querySnapshot.docs[querySnapshot.docs.length - 1]; // For pagination
                querySnapshot.forEach((doc) => {
                    const listing = doc.data();
                    createProductCard(listing);
                });
            }

            // Hide "Show More" button if there are no more products to load
            if (querySnapshot.size < productsToShow) {
                showMoreBtn.style.display = "none";
            }
        }


        // Function to create a product card and add it to the container
        function createProductCard(listing) {
            const productCard = document.createElement('div');
            productCard.className = 'col-lg-3 col-md-4 col-sm-6';

            const imageURL = (listing.imageURLs && listing.imageURLs.length > 0) ? listing.imageURLs[0] : 'https://via.placeholder.com/180';

            productCard.innerHTML = `
                <div class="product-card">
                    <div class="user-info">
                        <img src="https://via.placeholder.com/40" alt="user profile">
                        <div class="user-details">
                            <p><strong>User</strong></p> <!-- Placeholder for user name -->
                        </div>
                    </div>
                    <img src="${imageURL}" alt="${listing.title}">
                    <div class="card-body">
                        <h5>${listing.title}</h5>
                        <p class="price">S$${listing.price}</p>
                        <p class="description">${listing.description || "No description provided"}</p>
                    </div>
                    <div class="location-info">
                        <i class="fas fa-map-marker-alt"></i>
                        <p>${listing.location}</p> <!-- Placeholder for location -->
                    </div>
                </div>`;
            productContainer.appendChild(productCard);
        }

        // Event listener for "Show More" button to load more listings
        showMoreBtn.addEventListener('click', () => {
            loadListings(false); // Load more listings without resetting
        });

        // Initial load when the page is ready
        loadListings();

        // Optional: You can add the search functionality and filters here as in your original code
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
